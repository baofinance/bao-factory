# bao-factory

Canonical Bao Factory contracts plus deterministic deployment helpers. We keep the factory in this dedicated subtree because its build needs to be _boringly consistent_: the same compiler flags, the same bytecode blob, and therefore the same deterministic deployment addresses across every downstream repo.

## Build status

[![CI](https://github.com/baofinance/bao-factory/actions/workflows/CI-test-foundry-stable.yml/badge.svg)](https://github.com/baofinance/bao-base/actions/workflows/CI-test-foundry-stable.yml)

## Production Deployment Guide

The `script/bao-factory` CLI handles all deployment operations. Run `--help` for full options.

### Initial Factory Deployment

This installs a non-functional, but upgradeable, factory. It does it by:

- deploying via Nick's factory a contract that can be UUPS upgraded only by the Bao Harbor multisig. The owner() function returns that address.
- the constructor in this "bootstrapper" contract deploys a minimal UUPS proxy whose initial implementation is itself. This is the actual factory whose address is deterministic based on the salt provided to Nick's factory.

```bash
# Deploy the bootstrap factory via Nick's Factory (deterministic address)
bao-factory --deploy --network mainnet --account <deployer> --etherscan <API_KEY>
```

So now we have a factory deployed at a predictable address but it has no factory functionality. Factory functionality comes with the next step.

See https://etherscan.io/address/0xD696E56b3A054734d4C6DCBD32E11a278b0EC458 for the harbor factory

### Upgrading to BaoFactory_v1

The bootstrap factory must be upgraded to `BaoFactory_v1` before use:

```bash
# 1. Deploy the implementation and get upgrade instructions
bao-factory --implementation src/BaoFactory_v1.sol:BaoFactory_v1  \
  --network mainnet --account <deployer> --etherscan <API_KEY>

# 2. The script outputs cast commands for the owner multisig to execute:
#    - upgradeToAndCall(address,bytes) to point proxy at new implementation
#    - setOperator(address,uint256) to authorize deployers
```

The functional factory implementation is now deployed and verified on etherscan. The proxy needs to be upgraded to point to this new implementation. This is done by the upgradeToAndCall call sent to it which can only be done via the Bao Harbor multisig.

In order to use the BaoFactory_v1 you need to be an operator. So make the setOperator call on the BaoHarbor multisig

## Source Layout

- `src/BaoFactory.sol` – upgradeable factory implementation with the production owner baked in.
- `src/BaoFactoryBytecode.sol` – captured creation code, Nick's Factory constants, and the predicted deterministic addresses.
- `src/BaoFactoryDeployment.sol` – shared helper that downstream repos import to "ensure" a BaoFactory exists.
- `test/` – unit tests that cover the deterministic deployment, operator management, and upgrade flows.

## Making changes to the BaoFactory

Treat `src/BaoFactory.sol` as frozen. Only touch it when you intentionally want to mint a _new_ BaoFactory that will generate different addresses for the same salt. I don't know a scenario where this would be needed.

But if there is one then,

1. Make the intentional change in `src/BaoFactory.sol` (and document _why_ in the commit message—future maintainers need that context).
2. Run the extractor to regenerate the captured creation code and metadata. This produces the
   implementation bytecode that existing proxies will upgrade into, so keep the toolchain pinned and deterministic:

   ```bash
   cd lib/bao-factory
   ./script/bao-factory --extract
   ```

   This overwrites `src/BaoFactoryBytecode.sol` with the new creation code, hashes, and predicted addresses.

3. Commit both the Solidity change and the regenerated bytecode so downstream repos stay deterministic.

Instead if the BaoFactory_v1 implementation is unsufficient, or you need to change the owner, then a new BaoFactory_v2 can be created with new functionality or a new owner. Note that the list of operators is transitory so a new implementation would not necessarily need to maintain the existing operators.

## Testing

Inside `lib/bao-factory` run:

```bash
yarn test           # convenience wrapper that invokes forge test
```
